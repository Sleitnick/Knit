"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[235],{3905:function(e,n,t){t.d(n,{Zo:function(){return u},kt:function(){return m}});var r=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=r.createContext({}),d=function(e){var n=r.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},u=function(e){var n=d(e.components);return r.createElement(s.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},p=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),p=d(t),m=a,f=p["".concat(s,".").concat(m)]||p[m]||c[m]||i;return t?r.createElement(f,l(l({ref:n},u),{},{components:t})):r.createElement(f,l({ref:n},u))}));function m(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,l=new Array(i);l[0]=p;var o={};for(var s in n)hasOwnProperty.call(n,s)&&(o[s]=n[s]);o.originalType=e,o.mdxType="string"==typeof e?e:a,l[1]=o;for(var d=2;d<i;d++)l[d]=t[d];return r.createElement.apply(null,l)}return r.createElement.apply(null,t)}p.displayName="MDXCreateElement"},72350:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return o},contentTitle:function(){return s},metadata:function(){return d},toc:function(){return u},default:function(){return p}});var r=t(87462),a=t(63366),i=(t(67294),t(3905)),l=["components"],o={sidebar_position:8},s="Middleware",d={unversionedId:"middleware",id:"middleware",isDocsHomePage:!1,title:"Middleware",description:"Knit's networking layer uses the Comm module internally, which allows for middleware to be introduced at both the inbound and outbound level. For example, if a service had a client method called GetMoney(player), and the client called that method, your service would then fire that function. If there is any inbound middleware on the server, the inbound middleware would fire before GetMoney is fired. And the outbound middleware would fire after GetMoney is fired.",source:"@site/docs/middleware.md",sourceDirName:".",slug:"/middleware",permalink:"/Knit/docs/middleware",editUrl:"https://github.com/Sleitnick/Knit/edit/master/docs/middleware.md",tags:[],version:"current",sidebarPosition:8,frontMatter:{sidebar_position:8},sidebar:"defaultSidebar",previous:{title:"Examples",permalink:"/Knit/docs/examples"},next:{title:"VS Code Snippets",permalink:"/Knit/docs/vscodesnippets"}},u=[{value:"Usage",id:"usage",children:[{value:"Examples",id:"examples",children:[{value:"Logger",id:"logger",children:[],level:4},{value:"Manipulation",id:"manipulation",children:[],level:4},{value:"Serialization",id:"serialization",children:[],level:4}],level:3}],level:2}],c={toc:u};function p(e){var n=e.components,t=(0,a.Z)(e,l);return(0,i.kt)("wrapper",(0,r.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"middleware"},"Middleware"),(0,i.kt)("p",null,"Knit's networking layer uses the ",(0,i.kt)("a",{parentName:"p",href:"https://sleitnick.github.io/RbxUtil/api/Comm/"},"Comm")," module internally, which allows for middleware to be introduced at both the inbound and outbound level. For example, if a service had a client method called ",(0,i.kt)("inlineCode",{parentName:"p"},"GetMoney(player)"),", and the client called that method, your service would then fire that function. If there is any inbound middleware on the server, the inbound middleware would fire ",(0,i.kt)("em",{parentName:"p"},"before")," ",(0,i.kt)("inlineCode",{parentName:"p"},"GetMoney")," is fired. And the outbound middleware would fire ",(0,i.kt)("em",{parentName:"p"},"after")," GetMoney is fired."),(0,i.kt)("p",null,"Middleware can be used to both transform inbound/outbound arguments, and also decide to drop requests/responses. This is useful for many use-cases, such as automatically serializing/deserializing complex data types over the network, or sanitizing incoming data."),(0,i.kt)("p",null,"Middleware can be added on both the server and client, and affects functions and signals."),(0,i.kt)("p",null,"As of right now, middleware is only at a global level across Knit. In the future, it will be possible to have custom middleware per service and controller."),(0,i.kt)("h2",{id:"usage"},"Usage"),(0,i.kt)("p",null,"Middleware is added when Knit is started: ",(0,i.kt)("inlineCode",{parentName:"p"},"Knit.Start({InboundMiddleware: {...}, OutboundMiddleware: {...}})"),'. Each "middleware" item in the tables is a function. On the client, this function takes an array table containing all the arguments passed along. On the server, it is nearly the same, except the first argument before the arguments table is the player.'),(0,i.kt)("p",null,"Each function should return a boolean, indicating whether or not to continue to the request/response. If ",(0,i.kt)("inlineCode",{parentName:"p"},"false"),", an optional variadic list of items can be returned, which will be returned back to the caller (essentially a short-circuit, but still returning data)."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Client middleware function signature: ",(0,i.kt)("inlineCode",{parentName:"li"},"(args: {any}) -> (boolean, ...)")),(0,i.kt)("li",{parentName:"ul"},"Server middleware function signature: ",(0,i.kt)("inlineCode",{parentName:"li"},"(player: Player, args: {any}) -> (boolean, ...)"))),(0,i.kt)("h3",{id:"examples"},"Examples"),(0,i.kt)("h4",{id:"logger"},"Logger"),(0,i.kt)("p",null,"Here's an example on the client which logs all inbound data from the server:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-lua"},"local function Logger(args: {any})\n    print(args)\n    return true\nend\n\nKnit.Start({\n    InboundMiddleware = {Logger}\n})\n")),(0,i.kt)("p",null,"Here's the same thing, but on the server. As you can see, the only difference is that the ",(0,i.kt)("inlineCode",{parentName:"p"},"player")," argument is added to the middleware function:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-lua"},"local function Logger(player: Player, args: {any})\n    print(player, args)\n    return true\nend\n\nKnit.Start({\n    InboundMiddleware = {Logger}\n})\n")),(0,i.kt)("h4",{id:"manipulation"},"Manipulation"),(0,i.kt)("p",null,"A more complex example, where any inbound number to the client is multiplied by 2:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-lua"},'local function DoubleNumbers(args)\n    for i,v in ipairs(args) do\n        if type(v) == "number" then\n            args[i] *= 2\n        end\n    end\n    return true\nend\n\nKnit.Start({InboundMiddleware = {DoubleNumbers}})\n')),(0,i.kt)("h4",{id:"serialization"},"Serialization"),(0,i.kt)("p",null,"Another example, where a simple class is serialized/deserialized on the client before/after remote network communication occurs. A similar setup could be used server-side to complete the loop:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-lua"},'-----------------------------------------------------\n-- Setup a simple class:\nlocal MyClass = {}\nMyClass.__index = MyClass\nMyClass.ClassName = "MyClass"\n\nfunction MyClass.new()\n    return setmetatable({\n        SomeData = "",\n    }, MyClass)\nend\n\nfunction MyClass:Serialize()\n    return {_CN = self.ClassName, D = self.SomeData}\nend\n\nfunction MyClass.deserialize(data)\n    local myClass = MyClass.new()\n    myClass.SomeData = data\n    return myClass\nend\n-----------------------------------------------------\n\n-- Setup middleware for class serialization/deserialization on client:\n\nlocal function InboundClass(args)\n    for i,v in ipairs(args) do\n        if type(v) == "table" and v._CN == "MyClass" then\n            args[i] = MyClass.deserialize(v)\n        end\n    end\n    return true\nend\n\nlocal function OutboundClass(args)\n    for i,v in ipairs(args) do\n        if type(v) == "table" and v.ClassName == "MyClass" then\n            args[i] = v:Serialize()\n        end\n    end\n    return true\nend\n\nKnit.Start({\n    InboundMiddleware = {InboundClass},\n    OutboundMiddleware = {OutboundClass}\n})\n')))}p.isMDXComponent=!0}}]);